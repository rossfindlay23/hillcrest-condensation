<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hillcrest Property Team – Condensation Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <style>
    :root {
      --hc-blue: #009fdf;
      --hc-navy: #003b5c;
      --hc-light: #e7f4fb;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      background: #f5f5f5;
      color: #222;
      font-size: 15px;
    }

    .page {
      width: 100%;
      margin: 0;
      padding: 0 12px 18px;
      box-sizing: border-box;
    }

    header {
      background: var(--hc-navy);
      color: white;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      margin-bottom: 10px;
    }

    header img {
      height: 36px;
      width: auto;
      object-fit: contain;
      background: transparent;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      font-size: 17px;
      margin: 0;
      line-height: 1.2;
    }

    header span {
      font-size: 11px;
      opacity: 0.9;
    }

    h2 {
      margin: 6px 0 0 0;
      font-size: 19px;
      font-weight: 700;
      color: var(--hc-navy);
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .note {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }

    label {
      display: block;
      margin-top: 0.7em;
      font-size: 14px;
      color: #333;
    }

    select {
      width: 100%;
      padding: 10px 10px;
      margin-top: 0.35em;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 17px;
      -webkit-appearance: none;
      background-color: #fff;
    }

    input[type="number"] {
      width: 100%;
      padding: 8px 8px;
      margin-top: 0.35em;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 15px;
    }

    .card {
      margin-top: 10px;
      padding: 12px 10px;
      border-radius: 8px;
      border: 1px solid #c3dff0;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .card-header {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--hc-navy);
    }

    .result-line {
      margin: 3px 0;
      font-size: 14px;
    }

    .big {
      font-weight: 600;
      font-size: 15px;
      color: var(--hc-navy);
    }

    #requiredTemp {
      background: var(--hc-light);
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
    }

    .warning {
      color: #b00020;
      margin-top: 5px;
      font-size: 13px;
    }

    .tenant-text {
      margin-top: 7px;
      padding-top: 5px;
      border-top: 1px dashed #c3dff0;
      font-size: 12px;
      color: #444;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn {
      flex-grow: 1;
      text-align: center;
      padding: 7px 6px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--hc-blue);
      color: #fff;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #c3dff0;
      color: var(--hc-navy);
    }

    .info-inline {
      flex-grow: 0;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 4px;
      margin-left: 4px;
    }

    #staffInfo {
      margin-top: 8px;
      display: none;
    }

    .saved-rooms {
      margin-top: 10px;
      font-size: 13px;
    }

    .saved-rooms-list {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .saved-room-chip {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid #c3dff0;
      background: #f0f7fb;
      font-size: 12px;
      cursor: pointer;
    }

    .saved-room-chip span {
      font-weight: 600;
    }

    .vent-section {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #c3dff0;
      font-size: 13px;
    }

    .vent-inline {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .vent-inline > div {
      flex: 1;
      min-width: 40%;
    }

    .vent-result {
      font-size: 13px;
      margin-top: 4px;
    }

    .vent-ok {
      color: #1b7f2a;
      font-weight: 600;
    }

    .vent-low {
      color: #b00020;
      font-weight: 600;
    }

    footer {
      text-align: center;
      font-size: 10px;
      color: #777;
      padding: 4px 0 2px;
    }

    #reportText {
      font-size: 12px;
      white-space: pre-wrap;
      background: #f7f9fb;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e0e7ec;
      max-height: 140px;
      overflow-y: auto;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <header>
    <img src="hillcrest-logo.jpg" alt="Hillcrest Homes logo">
    <div class="title-block">
      <h1>Hillcrest Property Team</h1>
      <span>Condensation Calculator &amp; Heating Helper</span>
    </div>
  </header>

  <div class="page">
    <div class="top-row">
      <h2>Condensation Calculator</h2>
      <button class="btn btn-outline info-inline" type="button" onclick="toggleStaffInfo()">
        ℹ️ Staff guidance
      </button>
    </div>

    <p class="note">
      For Hillcrest Property staff on visits. Select the room temperature and relative humidity
      to estimate the dew point and the temperature needed to reach the target RH.
    </p>

    <div id="staffInfo" class="card">
      <div class="card-header">Quick staff guidance</div>
      <div class="result-line">1. Take a reading of room temperature and relative humidity.</div>
      <div class="result-line">2. Use the drop-downs to select the nearest values. Keep target RH at 60% unless agreed otherwise.</div>
      <div class="result-line">3. Use the highlighted “Required temperature” result to discuss heating advice.</div>
      <div class="result-line">4. If a high temperature is needed, stress ventilation & moisture reduction.</div>
      <div class="result-line">5. “RH at 20°C” indicates whether 20°C heating alone is enough.</div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" type="button" onclick="resetForm()">Reset / clear values</button>
      <button class="btn btn-outline" type="button" onclick="saveRoom()">Save this room</button>
    </div>

    <label>
      Current temperature (°C)
      <select id="temp">
        <option value="">Select temperature…</option>
        <option value="10">10.0</option><option value="10.5">10.5</option>
        <option value="11">11.0</option><option value="11.5">11.5</option>
        <option value="12">12.0</option><option value="12.5">12.5</option>
        <option value="13">13.0</option><option value="13.5">13.5</option>
        <option value="14">14.0</option><option value="14.5">14.5</option>
        <option value="15">15.0</option><option value="15.5">15.5</option>
        <option value="16">16.0</option><option value="16.5">16.5</option>
        <option value="17">17.0</option><option value="17.5">17.5</option>
        <option value="18">18.0</option><option value="18.5">18.5</option>
        <option value="19">19.0</option><option value="19.5">19.5</option>
        <option value="20">20.0</option><option value="20.5">20.5</option>
        <option value="21">21.0</option><option value="21.5">21.5</option>
        <option value="22">22.0</option><option value="22.5">22.5</option>
        <option value="23">23.0</option><option value="23.5">23.5</option>
        <option value="24">24.0</option><option value="24.5">24.5</option>
        <option value="25">25.0</option>
      </select>
    </label>

    <label>
      Current relative humidity (%)
      <select id="rh">
        <option value="">Select RH…</option>
        <option value="40">40%</option><option value="45">45%</option>
        <option value="50">50%</option><option value="55">55%</option>
        <option value="60">60%</option><option value="65">65%</option>
        <option value="70">70%</option><option value="75">75%</option>
        <option value="80">80%</option><option value="85">85%</option>
        <option value="90">90%</option>
      </select>
    </label>

    <label>
      Target relative humidity (%)
      <span class="note">(Default 60%. Only change if needed.)</span>
      <select id="targetRh">
        <option value="55">55%</option>
        <option value="60" selected>60%</option>
        <option value="65">65%</option>
        <option value="70">70%</option>
      </select>
    </label>

    <div id="warning" class="warning"></div>

    <div class="card">
      <div class="card-header">Results for this room</div>

      <div class="result-line big">
        Dew point: <span id="dewpoint">–</span> °C
      </div>

      <div class="result-line big">
        Required temp to reach target RH: <span id="requiredTemp">–</span> °C
      </div>

      <div class="result-line">
        Estimated RH if heated to 20°C: <span id="rhAt20">–</span>%
      </div>

      <div class="tenant-text" id="tenantText">
        Once you select the values above, a simple explanation to use with the tenant will appear here.
      </div>

      <div class="vent-section">
        <div class="card-header" style="margin-bottom:4px;">Ventilation check (optional)</div>
        <p class="note" style="margin-top:0;">
          Enter room dimensions and extract rate. Volume is calculated automatically.
        </p>
        <div class="vent-inline">
          <div>
            <label style="margin-top:0;">
              Width (m)
              <input type="number" id="roomWidth" step="0.1" placeholder="e.g. 4">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Length (m)
              <input type="number" id="roomLength" step="0.1" placeholder="e.g. 3.5">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Height (m)
              <input type="number" id="roomHeight" step="0.1" placeholder="e.g. 2.4">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Extract rate (L/s)
              <input type="number" id="extractRate" step="0.1" placeholder="e.g. 15">
            </label>
          </div>
        </div>
        <div class="vent-result" id="ventResult">
          Enter width, length, height and extract rate to estimate volume and air changes per hour (ACH).
        </div>
      </div>
    </div>

    <div class="saved-rooms">
      <div class="card-header">Saved rooms on this device</div>
      <div class="note">Tap a room to load its values back into the calculator.</div>
      <div class="saved-rooms-list" id="savedRoomsList"></div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div class="card-header">Generated report text</div>
      <p class="note">Use this report text in your notes, emails or case records.</p>
      <div id="reportText">No report generated yet.</div>
      <div class="btn-row" style="margin-top:6px;">
        <button class="btn btn-outline" type="button" onclick="generateReport()">Generate report text</button>
        <button class="btn btn-primary" type="button" onclick="copyReport()">Copy report</button>
      </div>
    </div>

    <p class="note" style="margin-top:6px;">
      Assumes moisture levels remain the same. Based on standard psychrometric relationships.
    </p>
  </div>

  <footer>
    Hillcrest Homes – Property Team • Condensation &amp; Heating Guidance Tool
  </footer>

  <script>
    const STORAGE_KEY = "hillcrest_saved_rooms_v1";
    let currentRoomName = "Current room";
    let lastVentSummary = "";
    let lastVolume = null;

    function satVapPressure(T) {
      return 0.6108 * Math.exp((17.27 * T) / (T + 237.3));
    }

    function tempFromSatVapPressure(es) {
      const lnTerm = Math.log(es / 0.6108);
      return (237.3 * lnTerm) / (17.27 - lnTerm);
    }

    function toNum(v) {
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }

    function calc() {
      const t = toNum(document.getElementById("temp").value);
      const rh = toNum(document.getElementById("rh").value);
      const targetRh = toNum(document.getElementById("targetRh").value);

      const warningEl = document.getElementById("warning");
      const dewEl = document.getElementById("dewpoint");
      const reqEl = document.getElementById("requiredTemp");
      const rh20El = document.getElementById("rhAt20");
      const tenantEl = document.getElementById("tenantText");

      warningEl.textContent = "";
      dewEl.textContent = "–";
      reqEl.textContent = "–";
      rh20El.textContent = "–";
      tenantEl.textContent =
        "Once you select the values above, a simple explanation to use with the tenant will appear here.";

      if (t === null || rh === null || targetRh === null) return;

      const es = satVapPressure(t);
      const e = (rh / 100) * es;

      const dewpoint = tempFromSatVapPressure(e);
      const esReq = e * (100 / targetRh);
      const requiredTemp = tempFromSatVapPressure(esReq);
      const es20 = satVapPressure(20);
      const rhAt20 = (e / es20) * 100;

      if (isFinite(dewpoint)) dewEl.textContent = dewpoint.toFixed(1);
      if (isFinite(requiredTemp)) reqEl.textContent = requiredTemp.toFixed(1);
      if (isFinite(rhAt20)) rh20El.textContent = rhAt20.toFixed(0);

      if (isFinite(requiredTemp) && isFinite(rhAt20)) {
        tenantEl.innerHTML =
          "Based on the current temperature of <strong>" + t.toFixed(1) + "°C</strong> at about " +
          rh.toFixed(0) + "% humidity, heating the room to around <strong>" +
          requiredTemp.toFixed(1) + "°C</strong> would bring the humidity down towards " +
          targetRh.toFixed(0) + "%." +
          " If the home is heated to <strong>20°C</strong>, the humidity would be roughly " +
          rhAt20.toFixed(0) + "%." +
          " Ventilation measures and reducing moisture (for example, lids on pans, drying clothes in a ventilated room, using/installing dMEV extract fans) is important and will help maintain a healthy environment within the home.";
      }

      calcVent();
    }

    function calcVent() {
      const w = toNum(document.getElementById("roomWidth").value);
      const l = toNum(document.getElementById("roomLength").value);
      const h = toNum(document.getElementById("roomHeight").value);
      const rate = toNum(document.getElementById("extractRate").value);
      const ventEl = document.getElementById("ventResult");

      lastVentSummary = "";
      lastVolume = null;

      if (w === null || l === null || h === null || rate === null ||
          w <= 0 || l <= 0 || h <= 0 || rate <= 0) {
        ventEl.textContent =
          "Enter width, length, height and extract rate to estimate volume and air changes per hour (ACH).";
        return;
      }

      const volume = w * l * h; // m³
      lastVolume = volume;

      const m3h = rate * 3.6; // L/s -> m³/h
      const ach = m3h / volume;

      let label =
        "Approx. room volume: " + volume.toFixed(1) + " m³. " +
        "Estimated ACH: " + ach.toFixed(1) + " air changes/hour. ";

      if (ach >= 3) {
        label += "This is broadly in a reasonable range for general moisture control.";
        ventEl.innerHTML = '<span class="vent-ok">' + label + "</span>";
      } else {
        label += "This appears low – consider improving extract capacity or run-time.";
        ventEl.innerHTML = '<span class="vent-low">' + label + "</span>";
      }

      lastVentSummary = label;
    }

    function resetForm() {
      document.getElementById("temp").value = "";
      document.getElementById("rh").value = "";
      document.getElementById("targetRh").value = "60";

      document.getElementById("roomWidth").value = "";
      document.getElementById("roomLength").value = "";
      document.getElementById("roomHeight").value = "";
      document.getElementById("extractRate").value = "";

      document.getElementById("reportText").textContent = "No report generated yet.";
      lastVentSummary = "";
      lastVolume = null;
      calc();
    }

    function toggleStaffInfo() {
      const el = document.getElementById("staffInfo");
      el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
    }

    function loadSavedRooms() {
      const listEl = document.getElementById("savedRoomsList");
      listEl.innerHTML = "";
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      let rooms;
      try {
        rooms = JSON.parse(raw);
      } catch {
        return;
      }
      if (!Array.isArray(rooms) || rooms.length === 0) return;

      rooms.forEach((room, idx) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "saved-room-chip";
        chip.innerHTML = "<span>" + room.name + "</span>";
        chip.onclick = () => loadRoom(idx);
        listEl.appendChild(chip);
      });
    }

    function saveRoom() {
      const tVal = document.getElementById("temp").value;
      const rhVal = document.getElementById("rh").value;
      const targetVal = document.getElementById("targetRh").value;
      const dewVal = document.getElementById("dewpoint").textContent;
      const reqVal = document.getElementById("requiredTemp").textContent;
      const rh20Val = document.getElementById("rhAt20").textContent;

      if (!tVal || !rhVal || !targetVal || dewVal === "–" || reqVal === "–") {
        alert("Please select values and run the calculation before saving a room.");
        return;
      }

      const name = prompt("Room name (e.g. Bedroom 1, Lounge):");
      if (!name) return;

      const raw = localStorage.getItem(STORAGE_KEY);
      let rooms = [];
      if (raw) {
        try {
          rooms = JSON.parse(raw) || [];
        } catch {
          rooms = [];
        }
      }

      rooms.push({
        name,
        temp: tVal,
        rh: rhVal,
        targetRh: targetVal,
        dew: dewVal,
        requiredTemp: reqVal,
        rhAt20: rh20Val
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
      currentRoomName = name;
      loadSavedRooms();
    }

    function loadRoom(index) {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      let rooms;
      try {
        rooms = JSON.parse(raw);
      } catch {
        return;
      }
      const room = rooms[index];
      if (!room) return;

      document.getElementById("temp").value = room.temp;
      document.getElementById("rh").value = room.rh;
      document.getElementById("targetRh").value = room.targetRh;
      currentRoomName = room.name;
      calc();
    }

    function generateReport() {
      const tVal = document.getElementById("temp").value;
      const rhVal = document.getElementById("rh").value;
      const targetVal = document.getElementById("targetRh").value;
      const dewVal = document.getElementById("dewpoint").textContent;
      const reqVal = document.getElementById("requiredTemp").textContent;
      const rh20Val = document.getElementById("rhAt20").textContent;
      const reportEl = document.getElementById("reportText");

      if (!tVal || !rhVal || !targetVal || dewVal === "–" || reqVal === "–" || rh20Val === "–") {
        alert("Please select values and run the calculation before generating a report.");
        return;
      }

      const lines = [];
      lines.push("Room: " + (currentRoomName || "Current room"));
      lines.push("Temperature: " + parseFloat(tVal).toFixed(1) + " °C");
      lines.push("Relative humidity: " + parseFloat(rhVal).toFixed(0) + " %");
      lines.push("Target relative humidity: " + parseFloat(targetVal).toFixed(0) + " %");
      lines.push("Dew point: " + dewVal + " °C");
      lines.push("Required temperature to reach target RH: " + reqVal + " °C");
      lines.push("Estimated RH if heated to 20 °C: " + rh20Val + " %");

      if (lastVolume !== null) {
        lines.push("Approx. room volume: " + lastVolume.toFixed(1) + " m³");
      }

      if (lastVentSummary) {
        lines.push("");
        lines.push("Ventilation:");
        lines.push(lastVentSummary);
      }

      lines.push("");
      lines.push(
        "Advisory summary: Based on the current conditions, heating the room to around " +
        reqVal + " °C would help bring humidity down towards " + parseFloat(targetVal).toFixed(0) +
        "%. Ventilation measures and reducing moisture (for example, lids on pans, drying clothes in a ventilated room, using/installing dMEV extract fans) is important and will help maintain a healthy environment within the home."
      );

      reportEl.textContent = lines.join("\n");
    }

    function copyReport() {
      const text = document.getElementById("reportText").textContent || "";
      if (!text || text === "No report generated yet.") {
        alert("Please generate a report first.");
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert("Report copied to clipboard."))
          .catch(() => alert("Could not copy automatically. Please tap and select the text manually."));
      } else {
        alert("Automatic copy not supported. Please tap and select the report text manually.");
      }
    }

    document.addEventListener("input", e => {
      if (
        e.target.matches("select") ||
        e.target.matches("#roomWidth") ||
        e.target.matches("#roomLength") ||
        e.target.matches("#roomHeight") ||
        e.target.matches("#extractRate")
      ) {
        if (
          e.target.id === "roomWidth" ||
          e.target.id === "roomLength" ||
          e.target.id === "roomHeight" ||
          e.target.id === "extractRate"
        ) {
          calcVent();
        } else {
          calc();
        }
      }
    });

    document.addEventListener("change", e => {
      if (e.target.matches("select")) calc();
    });

    calc();
    loadSavedRooms();
  </script>
</body>
</html>