<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CM Toolbox – Condensation, Ventilation & Air Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <style>
    :root {
      --primary: #005b96;
      --primary-light: #e5f1fb;
      --accent: #009fdf;
      --bg: #f5f5f5;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      background: var(--bg);
      color: #222;
      font-size: 15px;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .app-icon {
      height: 32px;
      width: 32px;
      border-radius: 8px;
      border: 2px solid rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--accent));
    }

    .title-block {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      font-size: 16px;
      margin: 0;
      line-height: 1.2;
    }

    header span {
      font-size: 11px;
      opacity: 0.9;
    }

    .page {
      width: 100%;
      margin: 0;
      padding: 10px 12px 18px;
      box-sizing: border-box;
    }

    h2 {
      margin: 4px 0 4px 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }

    .note {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }

    /* TOOLBOX HOME */

    .toolbox-header {
      margin-bottom: 8px;
    }

    .tile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .tile {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #d2e2f0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 90px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
    }

    .tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.10);
      border-color: var(--accent);
    }

    .tile-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary);
    }

    .tile-sub {
      font-size: 12px;
      margin-top: 4px;
      color: #555;
    }

    .tile-badge {
      align-self: flex-start;
      margin-top: 8px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }

    .back-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .back-btn {
      border: none;
      background: transparent;
      color: var(--primary);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 0;
      cursor: pointer;
    }

    .back-btn span {
      font-size: 14px;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn {
      flex-grow: 1;
      text-align: center;
      padding: 7px 6px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #d2e2f0;
      color: var(--primary);
    }

    .info-inline {
      flex-grow: 0;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 4px;
      margin-left: 4px;
    }

    .card {
      margin-top: 10px;
      padding: 12px 10px;
      border-radius: 8px;
      border: 1px solid #d2e2f0;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .card-header {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--primary);
    }

    label {
      display: block;
      margin-top: 0.7em;
      font-size: 14px;
      color: #333;
    }

    select {
      width: 100%;
      padding: 10px 10px;
      margin-top: 0.35em;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 17px;
      -webkit-appearance: none;
      background-color: #fff;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 8px 8px;
      margin-top: 0.35em;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 15px;
    }

    .result-line {
      margin: 3px 0;
      font-size: 14px;
    }

    .big {
      font-weight: 600;
      font-size: 15px;
      color: var(--primary);
    }

    #requiredTemp {
      background: var(--primary-light);
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
    }

    .warning {
      color: #b00020;
      margin-top: 5px;
      font-size: 13px;
    }

    .tenant-text {
      margin-top: 7px;
      padding-top: 5px;
      border-top: 1px dashed #d2e2f0;
      font-size: 12px;
      color: #444;
    }

    .saved-rooms {
      margin-top: 10px;
      font-size: 13px;
    }

    .saved-rooms-list {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .saved-room-chip {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid #d2e2f0;
      background: #f0f7fb;
      font-size: 12px;
      cursor: pointer;
    }

    .saved-room-chip span {
      font-weight: 600;
    }

    .vent-section {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #d2e2f0;
      font-size: 13px;
    }

    .vent-inline {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .vent-inline > div {
      flex: 1;
      min-width: 40%;
    }

    .vent-result {
      font-size: 13px;
      margin-top: 4px;
    }

    .vent-ok {
      color: #1b7f2a;
      font-weight: 600;
    }

    .vent-low {
      color: #b00020;
      font-weight: 600;
    }

    #reportText {
      font-size: 12px;
      white-space: pre-wrap;
      background: #f7f9fb;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e0e7ec;
      max-height: 140px;
      overflow-y: auto;
      margin-top: 4px;
    }

    /* Air test styles */
    .inline-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .inline-fields > div {
      flex: 1;
      min-width: 40%;
    }

    .airtest-highlight {
      font-weight: 600;
      color: var(--primary);
    }

    .airtest-note {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }

    /* Moisture diagnosis */
    .symptom-group {
      margin-top: 6px;
      font-size: 13px;
    }

    .symptom-group label {
      margin-top: 0.2em;
      font-size: 13px;
    }

    .symptom-group input[type="checkbox"] {
      margin-right: 4px;
    }

    .diag-heading {
      font-weight: 600;
      margin-top: 4px;
      font-size: 14px;
    }

    .diag-result-main {
      font-weight: 600;
      color: var(--primary);
      margin-top: 4px;
    }

    .diag-result-secondary {
      font-size: 13px;
      margin-top: 3px;
    }

    /* Heat loss */
    .hl-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .hl-inline > div {
      flex: 1;
      min-width: 40%;
    }

    .hl-highlight {
      color: var(--primary);
      font-weight: 600;
    }

    .hl-note {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }

    footer {
      text-align: center;
      font-size: 10px;
      color: #777;
      padding: 4px 0 6px;
    }
  </style>
</head>

<body>
  <header>
    <div class="app-icon">CM</div>
    <div class="title-block">
      <h1>CM Toolbox</h1>
      <span>Condensation • Ventilation • Air Test</span>
    </div>
    <!-- Hidden logo element for PDF use – change src to your actual logo file if different -->
    <img id="appLogo" src="cm-logo.png" alt="Logo" style="display:none;">
  </header>

  <!-- HOME / TOOLBOX VIEW -->
  <div id="view-home" class="page">
    <div class="toolbox-header">
      <h2>Toolbox</h2>
      <p class="note">
        Choose a tool to support on-site surveys, damp and mould visits, PAS2035 work or air-tightness assessments.
        Designed for quick use on a phone.
      </p>
    </div>

    <div class="tile-grid">
      <div class="tile" onclick="showView('condensation')">
        <div>
          <div class="tile-title">Condensation & Ventilation</div>
          <div class="tile-sub">
            Dew point, target heating temperature, RH at 20°C, room volume and ACH check with PDF report.
          </div>
        </div>
        <div class="tile-badge">Most used</div>
      </div>

      <div class="tile" onclick="showView('airtest')">
        <div>
          <div class="tile-title">Air Test / Envelope Helper</div>
          <div class="tile-sub">
            Approximate envelope area & volume, estimate n₅₀ and q₅₀ from test flow for simple box-shaped dwellings.
          </div>
        </div>
        <div class="tile-badge">Beta</div>
      </div>

      <div class="tile" onclick="showView('moisture')">
        <div>
          <div class="tile-title">Moisture Diagnosis</div>
          <div class="tile-sub">
            Symptom-based triage to distinguish condensation, penetrating, rising and plumbing-related damp.
          </div>
        </div>
        <div class="tile-badge">New</div>
      </div>

      <div class="tile" onclick="showView('heatloss')">
        <div>
          <div class="tile-title">Room Heat-Loss & Rad Size</div>
          <div class="tile-sub">
            Room dims, fabric U-values & ΔT to estimate design heat-loss and suggested radiator output.
          </div>
        </div>
        <div class="tile-badge">New</div>
      </div>

      <div class="tile" style="opacity:0.5; cursor:default;">
        <div>
          <div class="tile-title">Future tools</div>
          <div class="tile-sub">
            Space for additional CM survey tools (fabric heat loss by whole dwelling, MVHR balancing, etc.).
          </div>
        </div>
        <div class="tile-badge">Coming soon</div>
      </div>
    </div>
  </div>

  <!-- CONDENSATION TOOL VIEW -->
  <div id="view-condensation" class="page" style="display:none;">
    <div class="back-row">
      <button class="back-btn" type="button" onclick="showView('home')">
        <span>←</span> Toolbox
      </button>
    </div>

    <h2>Condensation & Ventilation Tool</h2>
    <p class="note">
      Estimate dew point, required heating temperature and ventilation performance to support
      damp and mould investigations on site.
    </p>

    <div id="staffInfo" class="card" style="display:none;">
      <div class="card-header">How to use on site</div>
      <div class="result-line">1. Take a room temperature and RH reading using a hygrometer.</div>
      <div class="result-line">2. Select the nearest values below. Keep target RH at 60% unless you have a specific reason to use another value.</div>
      <div class="result-line">3. Use the highlighted “Required temperature” as part of your heating advice.</div>
      <div class="result-line">4. Use the ventilation section to check whether the extract looks broadly adequate for the room size and type.</div>
      <div class="result-line">5. Use the generated report text/PDF in your notes, letters or case management system.</div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" type="button" onclick="resetForm()">Reset / clear</button>
      <button class="btn btn-outline" type="button" onclick="saveRoom()">Save this room</button>
      <button class="btn btn-outline info-inline" type="button" onclick="toggleStaffInfo()">
        ℹ️ Staff guidance
      </button>
    </div>

    <label>
      Current temperature (°C)
      <select id="temp">
        <option value="">Select temperature…</option>
        <option value="10">10.0</option><option value="10.5">10.5</option>
        <option value="11">11.0</option><option value="11.5">11.5</option>
        <option value="12">12.0</option><option value="12.5">12.5</option>
        <option value="13">13.0</option><option value="13.5">13.5</option>
        <option value="14">14.0</option><option value="14.5">14.5</option>
        <option value="15">15.0</option><option value="15.5">15.5</option>
        <option value="16">16.0</option><option value="16.5">16.5</option>
        <option value="17">17.0</option><option value="17.5">17.5</option>
        <option value="18">18.0</option><option value="18.5">18.5</option>
        <option value="19">19.0</option><option value="19.5">19.5</option>
        <option value="20">20.0</option><option value="20.5">20.5</option>
        <option value="21">21.0</option><option value="21.5">21.5</option>
        <option value="22">22.0</option><option value="22.5">22.5</option>
        <option value="23">23.0</option><option value="23.5">23.5</option>
        <option value="24">24.0</option><option value="24.5">24.5</option>
        <option value="25">25.0</option>
      </select>
    </label>

    <label>
      Current relative humidity (%)
      <select id="rh">
        <option value="">Select RH…</option>
        <option value="40">40%</option><option value="45">45%</option>
        <option value="50">50%</option><option value="55">55%</option>
        <option value="60">60%</option><option value="65">65%</option>
        <option value="70">70%</option><option value="75">75%</option>
        <option value="80">80%</option><option value="85">85%</option>
        <option value="90">90%</option>
      </select>
    </label>

    <label>
      Target relative humidity (%)
      <span class="note">(Typical target 60% RH.)</span>
      <select id="targetRh">
        <option value="55">55%</option>
        <option value="60" selected>60%</option>
        <option value="65">65%</option>
        <option value="70">70%</option>
      </select>
    </label>

    <div id="warning" class="warning"></div>

    <div class="card">
      <div class="card-header">Calculated results</div>

      <div class="result-line big">
        Dew point: <span id="dewpoint">–</span> °C
      </div>

      <div class="result-line big">
        Required temp to reach target RH: <span id="requiredTemp">–</span> °C
      </div>

      <div class="result-line">
        Estimated RH if heated to 20°C: <span id="rhAt20">–</span>%
      </div>

      <div class="tenant-text" id="tenantText">
        Once you select the values above, a simple explanation for occupants will appear here.
      </div>

      <div class="vent-section">
        <div class="card-header" style="margin-bottom:4px;">Ventilation check (optional)</div>
        <label style="margin-top:0;">
          Room type (sets target ACH)
          <select id="roomType">
            <option value="bed" selected>Bedroom / Living room (target ~3 ACH)</option>
            <option value="kit">Kitchen (target ~5 ACH)</option>
            <option value="bath">Bathroom / shower room (target ~7 ACH)</option>
            <option value="util">Utility / drying room (target ~6 ACH)</option>
          </select>
        </label>
        <p class="note" style="margin-top:2px;">
          Enter room dimensions and extract rate. Volume is calculated automatically and used to estimate ACH.
        </p>
        <div class="vent-inline">
          <div>
            <label style="margin-top:0;">
              Width (m)
              <input type="number" id="roomWidth" step="0.1" placeholder="e.g. 4">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Length (m)
              <input type="number" id="roomLength" step="0.1" placeholder="e.g. 3.5">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Height (m)
              <input type="number" id="roomHeight" step="0.1" placeholder="e.g. 2.4">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Extract rate (L/s)
              <input type="number" id="extractRate" step="0.1" placeholder="e.g. 15">
            </label>
          </div>
        </div>
        <div class="vent-result" id="ventResult">
          Enter width, length, height and extract rate to estimate volume and air changes per hour (ACH).
        </div>
      </div>
    </div>

    <div class="saved-rooms">
      <div class="card-header">Saved rooms on this device</div>
      <div class="note">Tap a room to load its values back into the calculator.</div>
      <div class="saved-rooms-list" id="savedRoomsList"></div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div class="card-header">Generated report text</div>
      <p class="note">Use this text or download as PDF for your records.</p>
      <div id="reportText">No report generated yet.</div>
      <div class="btn-row" style="margin-top:6px;">
        <button class="btn btn-outline" type="button" onclick="generateReport()">Generate report</button>
        <button class="btn btn-primary" type="button" onclick="downloadPdf()">Download PDF report</button>
      </div>
    </div>

    <p class="note" style="margin-top:6px;">
      For professional guidance only. Assumes moisture levels remain constant during heating.
      Based on standard psychrometric relationships.
    </p>
  </div>

  <!-- AIR TEST / ENVELOPE TOOL VIEW -->
  <div id="view-airtest" class="page" style="display:none;">
    <div class="back-row">
      <button class="back-btn" type="button" onclick="showView('home')">
        <span>←</span> Toolbox
      </button>
    </div>

    <h2>Air Test / Envelope Helper (beta)</h2>
    <p class="note">
      Simple box-model helper for typical dwellings. Approximates envelope area and internal volume, then uses
      measured flow at 50 Pa to estimate air permeability (q₅₀) and air changes at 50 Pa (n₅₀).
      Always cross-check against the official test certificate.
    </p>

    <div class="card">
      <div class="card-header">Inputs – box approximation</div>
      <div class="inline-fields">
        <div>
          <label>
            Length of building (m)
            <input type="number" id="at_length" step="0.1" placeholder="e.g. 10">
          </label>
        </div>
        <div>
          <label>
            Width of building (m)
            <input type="number" id="at_width" step="0.1" placeholder="e.g. 6">
          </label>
        </div>
      </div>

      <div class="inline-fields">
        <div>
          <label>
            Storeys (heated)
            <input type="number" id="at_storeys" step="1" placeholder="e.g. 2">
          </label>
        </div>
        <div>
          <label>
            Storey height (m)
            <input type="number" id="at_height" step="0.1" placeholder="e.g. 2.4">
          </label>
        </div>
      </div>

      <label>
        Measured flow at 50 Pa (m³/h)
        <span class="note">(From test certificate – optional but needed for q₅₀ / n₅₀)</span>
        <input type="number" id="at_flow" step="1" placeholder="e.g. 1500">
      </label>

      <p class="airtest-note">
        Box approximation assumes a rectangular plan with flat roof. For more complex shapes
        (L-plans, stepped roofs, attached garages) adjust dimensions or use surveyor judgement.
      </p>
    </div>

    <div class="card">
      <div class="card-header">Calculated envelope & air-tightness</div>
      <div class="result-line">
        Approx. internal volume: <span class="airtest-highlight" id="at_volume">–</span> m³
      </div>
      <div class="result-line">
        Approx. envelope area (incl. ground floor & roof): <span class="airtest-highlight" id="at_envelope">–</span> m²
      </div>
      <div class="result-line">
        Air permeability q₅₀ (flow / area): <span class="airtest-highlight" id="at_q50">–</span> m³/(h·m²)
      </div>
      <div class="result-line">
        Air changes at 50 Pa n₅₀ (flow / volume): <span class="airtest-highlight" id="at_n50">–</span> 1/h
      </div>
      <div class="result-line" id="at_comment"></div>

      <p class="airtest-note">
        Typical design targets for dwellings (UK) are often around 5 m³/(h·m²) at 50 Pa, but always refer to the specific
        standard or employer requirement for the project. This tool is for quick cross-checking only.
      </p>
    </div>
  </div>

  <!-- MOISTURE DIAGNOSIS VIEW -->
  <div id="view-moisture" class="page" style="display:none;">
    <div class="back-row">
      <button class="back-btn" type="button" onclick="showView('home')">
        <span>←</span> Toolbox
      </button>
    </div>

    <h2>Moisture Diagnosis Tool</h2>
    <p class="note">
      Symptom-based triage to help distinguish likely condensation, penetrating damp, rising damp, plumbing leaks
      and thermal bridging issues. For professional guidance, not a replacement for full building pathology.
    </p>

    <div class="card">
      <div class="card-header">1. Building context</div>
      <label>
        Approximate build type / age
        <select id="md_age">
          <option value="">Select…</option>
          <option value="pre1919">Pre-1919 solid wall</option>
          <option value="1919-1980">1919–1980 cavity / mixed</option>
          <option value="post1980">Post-1980 cavity / insulated</option>
          <option value="newbuild">Recent new-build / highly insulated</option>
        </select>
      </label>

      <label>
        Typical heating pattern
        <select id="md_heating">
          <option value="">Select…</option>
          <option value="intermittent">Intermittent / off most of day</option>
          <option value="evening">Mainly evenings</option>
          <option value="steady">Fairly steady background heat</option>
        </select>
      </label>

      <label>
        Ventilation / extract fans
        <select id="md_vent">
          <option value="">Select…</option>
          <option value="poor">Limited ventilation / fans rarely used</option>
          <option value="mixed">Some ventilation, but inconsistent</option>
          <option value="good">Generally good ventilation and extract</option>
        </select>
      </label>
    </div>

    <div class="card">
      <div class="card-header">2. Symptoms observed</div>

      <div class="symptom-group">
        <div class="diag-heading">Internal surfaces</div>
        <label><input type="checkbox" class="md-symptom" value="mouldCorners"> Mould in corners / behind furniture / on external walls</label>
        <label><input type="checkbox" class="md-symptom" value="windowCond"> Condensation and mould on window reveals / frames</label>
        <label><input type="checkbox" class="md-symptom" value="ceilingEdge"> Dark staining at ceiling / wall junctions (cold edges)</label>
        <label><input type="checkbox" class="md-symptom" value="patchMidWall"> Damp patch mid-wall, not at floor or ceiling junction</label>
        <label><input type="checkbox" class="md-symptom" value="tideMarks"> Tide marks / salts at base of wall (up to ~1 m)</label>
      </div>

      <div class="symptom-group">
        <div class="diag-heading">External / rain related</div>
        <label><input type="checkbox" class="md-symptom" value="chimney"> Damp around chimney breast / unused flues</label>
        <label><input type="checkbox" class="md-symptom" value="roofGutter"> Damp below roof line / gutters / valleys</label>
        <label><input type="checkbox" class="md-symptom" value="exposedWall"> Damp mainly on one very exposed elevation</label>
      </div>

      <div class="symptom-group">
        <div class="diag-heading">Plumbing / services</div>
        <label><input type="checkbox" class="md-symptom" value="pipeLocal"> Very localised damp near pipework / bathroom / kitchen</label>
        <label><input type="checkbox" class="md-symptom" value="aboveCeiling"> Staining on ceilings below bathroom or pipe routes</label>
      </div>

      <div class="symptom-group">
        <div class="diag-heading">Occupancy / moisture load</div>
        <label><input type="checkbox" class="md-symptom" value="manyOccupants"> High occupancy / lots of internal moisture (drying clothes inside, etc.)</label>
        <label><input type="checkbox" class="md-symptom" value="coldHouse"> Property reported as hard to keep warm / often cold</label>
      </div>
    </div>

    <div class="card">
      <div class="card-header">3. Likely diagnosis</div>
      <div class="diag-result-main" id="md_main">Select symptoms to see likely causes.</div>
      <div class="diag-result-secondary" id="md_secondary"></div>
      <div class="diag-result-secondary" id="md_actions" style="margin-top:6px;"></div>
    </div>

    <p class="note" style="margin-top:6px;">
      This triage is designed to support consistent recording and explanation, not to replace a full surveyor’s judgement.
      Multiple mechanisms can be present at the same time.
    </p>
  </div>

  <!-- HEAT-LOSS & RADIATOR SIZING VIEW -->
  <div id="view-heatloss" class="page" style="display:none;">
    <div class="back-row">
      <button class="back-btn" type="button" onclick="showView('home')">
        <span>←</span> Toolbox
      </button>
    </div>

    <h2>Room Heat-Loss & Radiator Sizing</h2>
    <p class="note">
      Quick room-level heat-loss estimate using simple U-values and a design temperature difference.
      Intended as a guide alongside MCS / SAP / full heat-loss calculations.
    </p>

    <div class="card">
      <div class="card-header">1. Room dimensions & design temperatures</div>
      <label>
        Room name (optional)
        <input type="text" id="hl_name" placeholder="e.g. Bedroom 1">
      </label>

      <div class="hl-inline">
        <div>
          <label>
            Length (m)
            <input type="number" id="hl_length" step="0.1" placeholder="e.g. 4.2">
          </label>
        </div>
        <div>
          <label>
            Width (m)
            <input type="number" id="hl_width" step="0.1" placeholder="e.g. 3.3">
          </label>
        </div>
      </div>

      <div class="hl-inline">
        <div>
          <label>
            Height (m)
            <input type="number" id="hl_height" step="0.1" placeholder="e.g. 2.4">
          </label>
        </div>
        <div>
          <label>
            Design internal temperature (°C)
            <input type="number" id="hl_tint" step="0.5" placeholder="e.g. 21">
          </label>
        </div>
      </div>

      <label>
        Design external temperature (°C)
        <span class="note">(For Scottish locations often around −1 to −3°C in design calcs; adjust to preference.)</span>
        <input type="number" id="hl_text" step="0.5" placeholder="e.g. -1">
      </label>
    </div>

    <div class="card">
      <div class="card-header">2. Fabric elements (simple presets)</div>

      <div class="hl-inline">
        <div>
          <label>
            Approx. external wall count
            <select id="hl_extWalls">
              <option value="1">1 external wall</option>
              <option value="2" selected>2 external walls</option>
              <option value="3">3 external walls</option>
              <option value="4">4 external walls</option>
            </select>
          </label>
        </div>
        <div>
          <label>
            Wall U-value (W/m²K)
            <select id="hl_uwall">
              <option value="1.7">Solid brick/stone (uninsulated ~1.7)</option>
              <option value="1.4">Uninsulated cavity (~1.4)</option>
              <option value="0.6">Partially insulated (~0.6)</option>
              <option value="0.3" selected>Modern insulated (~0.3)</option>
            </select>
          </label>
        </div>
      </div>

      <div class="hl-inline">
        <div>
          <label>
            Window / glazing area (m²)
            <input type="number" id="hl_awin" step="0.1" placeholder="e.g. 2.5">
          </label>
        </div>
        <div>
          <label>
            Window U-value (W/m²K)
            <select id="hl_uwin">
              <option value="3.0">Old double glazing (~3.0)</option>
              <option value="1.8" selected>Modern double (~1.8)</option>
              <option value="1.2">Better triple (~1.2)</option>
            </select>
          </label>
        </div>
      </div>

      <div class="hl-inline">
        <div>
          <label>
            Floor U-value (W/m²K)
            <select id="hl_ufloor">
              <option value="0.7">Uninsulated suspended (~0.7)</option>
              <option value="0.5">Basic insulated (~0.5)</option>
              <option value="0.25" selected>Modern insulated (~0.25)</option>
            </select>
          </label>
        </div>
        <div>
          <label>
            Ceiling / roof U-value (W/m²K)
            <select id="hl_uroof">
              <option value="0.4">Poor loft insulation (~0.4)</option>
              <option value="0.25">Improved (~0.25)</option>
              <option value="0.16" selected>Good loft insulation (~0.16)</option>
            </select>
          </label>
        </div>
      </div>

      <p class="hl-note">
        Wall area is approximated from room perimeter, height and number of external walls (assuming a roughly rectangular room).
        Floor and roof areas use the full room area.
      </p>
    </div>

    <div class="card">
      <div class="card-header">3. Heat-loss estimate</div>
      <div class="result-line">
        ΔT (inside – outside): <span class="hl-highlight" id="hl_dT">–</span> K
      </div>
      <div class="result-line">
        Fabric heat-loss: <span class="hl-highlight" id="hl_Qfabric">–</span> W/K
      </div>
      <div class="result-line">
        Design heat-loss (fabric × ΔT, incl. 10% margin): <span class="hl-highlight" id="hl_Qdesign">–</span> W
      </div>
      <div class="result-line">
        Suggested radiator output (rounded): <span class="hl-highlight" id="hl_rad">–</span> W
      </div>
      <p class="hl-note">
        Radiator outputs are usually quoted at specific temperature conditions (e.g. ΔT50). This figure is a useful sense-check
        rather than a replacement for full heat-loss or manufacturer sizing.
      </p>
    </div>
  </div>

  <footer>
    CM Toolbox • Condensation, Ventilation, Moisture & Air Test • © Your Name / Company
  </footer>

  <!-- jsPDF and AutoTable for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    const STORAGE_KEY = "cvtool_saved_rooms_v1";
    let currentRoomName = "Current room";
    let lastVentSummary = "";
    let lastVolume = null;

    /* ---------- VIEW SWITCHING ---------- */
    function showView(view) {
      document.getElementById("view-home").style.display =
        view === "home" ? "block" : "none";
      document.getElementById("view-condensation").style.display =
        view === "condensation" ? "block" : "none";
      document.getElementById("view-airtest").style.display =
        view === "airtest" ? "block" : "none";
      document.getElementById("view-moisture").style.display =
        view === "moisture" ? "block" : "none";
      document.getElementById("view-heatloss").style.display =
        view === "heatloss" ? "block" : "none";
    }

    /* ---------- PSYCHROMETRIC CORE ---------- */
    function satVapPressure(T) {
      return 0.6108 * Math.exp((17.27 * T) / (T + 237.3));
    }

    function tempFromSatVapPressure(es) {
      const lnTerm = Math.log(es / 0.6108);
      return (237.3 * lnTerm) / (17.27 - lnTerm);
    }

    function toNum(v) {
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }

    function getTargetAch() {
      const type = document.getElementById("roomType").value;
      switch (type) {
        case "kit": return 5.0;
        case "bath": return 7.0;
        case "util": return 6.0;
        case "bed":
        default: return 3.0;
      }
    }

    function calc() {
      const t = toNum(document.getElementById("temp").value);
      const rh = toNum(document.getElementById("rh").value);
      const targetRh = toNum(document.getElementById("targetRh").value);

      const warningEl = document.getElementById("warning");
      const dewEl = document.getElementById("dewpoint");
      const reqEl = document.getElementById("requiredTemp");
      const rh20El = document.getElementById("rhAt20");
      const tenantEl = document.getElementById("tenantText");

      warningEl.textContent = "";
      dewEl.textContent = "–";
      reqEl.textContent = "–";
      rh20El.textContent = "–";
      tenantEl.textContent =
        "Once you select the values above, a simple explanation for occupants will appear here.";

      if (t === null || rh === null || targetRh === null) {
        calcVent();
        return;
      }

      const es = satVapPressure(t);
      const e = (rh / 100) * es;

      const dewpoint = tempFromSatVapPressure(e);
      const esReq = e * (100 / targetRh);
      const requiredTemp = tempFromSatVapPressure(esReq);
      const es20 = satVapPressure(20);
      const rhAt20 = (e / es20) * 100;

      if (isFinite(dewpoint)) dewEl.textContent = dewpoint.toFixed(1);
      if (isFinite(requiredTemp)) reqEl.textContent = requiredTemp.toFixed(1);
      if (isFinite(rhAt20)) rh20El.textContent = rhAt20.toFixed(0);

      if (isFinite(requiredTemp) && isFinite(rhAt20)) {
        tenantEl.innerHTML =
          "Based on the current temperature of <strong>" + t.toFixed(1) + "°C</strong> at about " +
          rh.toFixed(0) + "% humidity, heating the room to around <strong>" +
          requiredTemp.toFixed(1) + "°C</strong> would bring the humidity down towards " +
          targetRh.toFixed(0) + "%." +
          " If the home is heated to <strong>20°C</strong>, the humidity would be roughly " +
          rhAt20.toFixed(0) + "%." +
          " Ventilation measures and reducing moisture (for example, lids on pans, drying clothes in a ventilated room, using/installing dMEV extract fans) is important and will help maintain a healthy environment within the home.";
      }

      calcVent();
    }

    /* ---------- VENTILATION SECTION ---------- */
    function calcVent() {
      const w = toNum(document.getElementById("roomWidth").value);
      const l = toNum(document.getElementById("roomLength").value);
      const h = toNum(document.getElementById("roomHeight").value);
      const rate = toNum(document.getElementById("extractRate").value);
      const ventEl = document.getElementById("ventResult");

      lastVentSummary = "";
      lastVolume = null;

      if (w === null || l === null || h === null || rate === null ||
          w <= 0 || l <= 0 || h <= 0 || rate <= 0) {
        ventEl.textContent =
          "Enter width, length, height and extract rate to estimate volume and air changes per hour (ACH).";
        return;
      }

      const volume = w * l * h; // m³
      lastVolume = volume;

      const m3h = rate * 3.6; // L/s -> m³/h
      const ach = m3h / volume;
      const targetAch = getTargetAch();

      let label =
        "Approx. room volume: " + volume.toFixed(1) + " m³. " +
        "Estimated ACH: " + ach.toFixed(1) + " air changes/hour. ";

      if (ach >= targetAch) {
        label += "This is broadly in a reasonable range for this type of room.";
        ventEl.innerHTML = '<span class="vent-ok">' + label + "</span>";
      } else {
        const requiredLs = (targetAch * volume) / 3.6; // L/s for target ACH
        label +=
          "This appears low – consider improving extract capacity or run-time. " +
          "To achieve around " + targetAch.toFixed(1) +
          " air changes/hour for this room type, the extract would need to be approximately " +
          requiredLs.toFixed(1) + " L/s based on the dimensions entered.";
        ventEl.innerHTML = '<span class="vent-low">' + label + "</span>";
      }

      lastVentSummary = label;
    }

    function resetForm() {
      document.getElementById("temp").value = "";
      document.getElementById("rh").value = "";
      document.getElementById("targetRh").value = "60";

      document.getElementById("roomType").value = "bed";
      document.getElementById("roomWidth").value = "";
      document.getElementById("roomLength").value = "";
      document.getElementById("roomHeight").value = "";
      document.getElementById("extractRate").value = "";

      document.getElementById("reportText").textContent = "No report generated yet.";
      lastVentSummary = "";
      lastVolume = null;
      calc();
    }

    function toggleStaffInfo() {
      const el = document.getElementById("staffInfo");
      el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
    }

    /* ---------- ROOM SAVE / LOAD ---------- */
    function loadSavedRooms() {
      const listEl = document.getElementById("savedRoomsList");
      listEl.innerHTML = "";
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      let rooms;
      try {
        rooms = JSON.parse(raw);
      } catch {
        return;
      }
      if (!Array.isArray(rooms) || rooms.length === 0) return;

      rooms.forEach((room, idx) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "saved-room-chip";
        chip.innerHTML = "<span>" + room.name + "</span>";
        chip.onclick = () => loadRoom(idx);
        listEl.appendChild(chip);
      });
    }

    function saveRoom() {
      const tVal = document.getElementById("temp").value;
      const rhVal = document.getElementById("rh").value;
      const targetVal = document.getElementById("targetRh").value;
      const dewVal = document.getElementById("dewpoint").textContent;
      const reqVal = document.getElementById("requiredTemp").textContent;
      const rh20Val = document.getElementById("rhAt20").textContent;

      if (!tVal || !rhVal || !targetVal || dewVal === "–" || reqVal === "–") {
        alert("Please select values and run the calculation before saving a room.");
        return;
      }

      const name = prompt("Room name (e.g. Bedroom 1, Lounge):");
      if (!name) return;

      const raw = localStorage.getItem(STORAGE_KEY);
      let rooms = [];
      if (raw) {
        try {
          rooms = JSON.parse(raw) || [];
        } catch {
          rooms = [];
        }
      }

      rooms.push({
        name,
        temp: tVal,
        rh: rhVal,
        targetRh: targetVal,
        dew: dewVal,
        requiredTemp: reqVal,
        rhAt20: rh20Val
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
      currentRoomName = name;
      loadSavedRooms();
    }

    function loadRoom(index) {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      let rooms;
      try {
        rooms = JSON.parse(raw);
      } catch {
        return;
      }
      const room = rooms[index];
      if (!room) return;

      document.getElementById("temp").value = room.temp;
      document.getElementById("rh").value = room.rh;
      document.getElementById("targetRh").value = room.targetRh;
      currentRoomName = room.name;
      calc();
    }

    /* ---------- REPORT TEXT ---------- */
    function generateReport() {
      const tVal = document.getElementById("temp").value;
      const rhVal = document.getElementById("rh").value;
      const targetVal = document.getElementById("targetRh").value;
      const dewVal = document.getElementById("dewpoint").textContent;
      const reqVal = document.getElementById("requiredTemp").textContent;
      const rh20Val = document.getElementById("rhAt20").textContent;
      const reportEl = document.getElementById("reportText");

      if (!tVal || !rhVal || !targetVal || dewVal === "–" || reqVal === "–" || rh20Val === "–") {
        alert("Please select values and run the calculation before generating a report.");
        return;
      }

      const lines = [];
      lines.push("Room: " + (currentRoomName || "Current room"));
      lines.push("Temperature: " + parseFloat(tVal).toFixed(1) + " °C");
      lines.push("Relative humidity: " + parseFloat(rhVal).toFixed(0) + " %");
      lines.push("Target relative humidity: " + parseFloat(targetVal).toFixed(0) + " %");
      lines.push("Dew point: " + dewVal + " °C");
      lines.push("Required temperature to reach target RH: " + reqVal + " °C");
      lines.push("Estimated RH if heated to 20 °C: " + rh20Val + " %");

      if (lastVolume !== null) {
        lines.push("Approx. room volume: " + lastVolume.toFixed(1) + " m³");
      }

      if (lastVentSummary) {
        lines.push("");
        lines.push("Ventilation:");
        lines.push(lastVentSummary);
      }

      lines.push("");
      lines.push(
        "Advisory summary: Based on the current conditions, heating the room to around " +
        reqVal + " °C would help bring humidity down towards " + parseFloat(targetVal).toFixed(0) +
        "%. Ventilation measures and reducing moisture (for example, lids on pans, drying clothes in a ventilated room, using/installing dMEV extract fans) is important and will help maintain a healthy environment within the home."
      );

      reportEl.textContent = lines.join("\n");
    }

    /* ---------- LOGO HELPER FOR PDF ---------- */
    async function getLogoDataUrl() {
      const imgEl = document.getElementById("appLogo");
      if (!imgEl || !imgEl.src) return null;

      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = function () {
          try {
            const canvas = document.createElement("canvas");
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            const dataUrl = canvas.toDataURL("image/png");
            resolve(dataUrl);
          } catch {
            resolve(null);
          }
        };
        img.onerror = () => resolve(null);
        img.src = imgEl.src;
      });
    }

    /* ---------- MOISTURE GRAPH FOR PDF ---------- */
    function drawMoistureGraph(doc, startY, tVal, rhVal, reqVal, targetVal, rh20Val) {
      const marginLeft = 12;
      const graphWidth = 130;
      const graphHeight = 60;
      let yTop = startY;
      let yBottom = yTop + graphHeight;

      if (yBottom > 270) {
        doc.addPage();
        yTop = 18;
        yBottom = yTop + graphHeight;
      }

      const xLeft = marginLeft;
      const xRight = xLeft + graphWidth;

      doc.setDrawColor(0);
      doc.line(xLeft, yBottom, xRight, yBottom); // X axis
      doc.line(xLeft, yTop, xLeft, yBottom);     // Y axis

      doc.setFontSize(9);
      doc.text("Temperature (°C)", xLeft + graphWidth / 2 - 15, yBottom + 5);
      doc.text("RH (%)", xLeft - 6, yTop - 2);

      const tMin = 5, tMax = 25;
      const rhMin = 40, rhMax = 100;

      function mapX(T) {
        const TT = Math.min(Math.max(T, tMin), tMax);
        return xLeft + ((TT - tMin) / (tMax - tMin)) * graphWidth;
      }

      function mapY(RH) {
        const RR = Math.min(Math.max(RH, rhMin), rhMax);
        return yBottom - ((RR - rhMin) / (rhMax - rhMin)) * graphHeight;
      }

      doc.setFontSize(8);
      for (let T = 5; T <= 25; T += 5) {
        const x = mapX(T);
        doc.line(x, yBottom, x, yBottom + 1.5);
        doc.text(String(T), x - 2, yBottom + 4);
      }
      for (let RH = 40; RH <= 100; RH += 20) {
        const y = mapY(RH);
        doc.line(xLeft - 1.5, y, xLeft, y);
        doc.text(String(RH), xLeft - 9, y + 2);
      }

      const haveMain =
        isFinite(tVal) && isFinite(rhVal) &&
        isFinite(reqVal) && isFinite(targetVal) &&
        isFinite(rh20Val);

      if (haveMain) {
        const x1 = mapX(tVal);
        const y1 = mapY(rhVal);

        const x2 = mapX(reqVal);
        const y2 = mapY(targetVal);

        const x3 = mapX(20);
        const y3 = mapY(rh20Val);

        doc.setDrawColor(0, 91, 150);
        doc.setLineWidth(0.4);
        doc.line(x1, y1, x2, y2);

        doc.setFillColor(0, 91, 150);
        doc.circle(x1, y1, 1.4, "F");
        doc.circle(x2, y2, 1.4, "F");

        doc.setFillColor(0, 159, 223);
        doc.circle(x3, y3, 1.4, "F");

        doc.setFontSize(8);
        doc.setTextColor(0, 0, 0);
        doc.text("Current", x1 + 1.5, y1 - 1);
        doc.text("Req./target", x2 + 1.5, y2 - 1);
        doc.text("20°C point", x3 + 1.5, y3 - 1);
      }

      return yBottom;
    }

    /* ---------- PDF GENERATION ---------- */
    async function downloadPdf() {
      const text = document.getElementById("reportText").textContent || "";
      if (!text || text === "No report generated yet.") {
        alert("Please generate a report first.");
        return;
      }

      if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API.autoTable) {
        alert("PDF library not loaded. Please check your connection and try again.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      const marginLeft = 12;
      let cursorY = 18;

      const logoDataUrl = await getLogoDataUrl();

      // HEADER
      doc.setFillColor(0, 91, 150);
      doc.rect(0, 0, 210, 18, "F");

      if (logoDataUrl) {
        doc.addImage(logoDataUrl, "PNG", 6, 3, 12, 12);
        doc.setTextColor(255, 255, 255);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(15);
        doc.text("Condensation & Ventilation Survey Report", 22, 12);
      } else {
        doc.setTextColor(255, 255, 255);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("Condensation & Ventilation Survey Report", marginLeft, 12);
      }

      doc.setTextColor(0, 0, 0);
      cursorY = 28;

      const roomName = currentRoomName || "Current room";
      const tValRaw = document.getElementById("temp").value || "-";
      const rhValRaw = document.getElementById("rh").value || "-";
      const targetValRaw = document.getElementById("targetRh").value || "-";

      const dewValRaw = document.getElementById("dewpoint").textContent || "-";
      const reqValRaw = document.getElementById("requiredTemp").textContent || "-";
      const rh20ValRaw = document.getElementById("rhAt20").textContent || "-";

      const tVal = parseFloat(tValRaw);
      const rhVal = parseFloat(rhValRaw);
      const targetVal = parseFloat(targetValRaw);
      const reqVal = parseFloat(reqValRaw);
      const rh20Val = parseFloat(rh20ValRaw);

      // 1. MEASURED CONDITIONS TABLE
      doc.setFontSize(14);
      doc.text("1. Measured Conditions", marginLeft, cursorY);
      cursorY += 4;

      doc.autoTable({
        startY: cursorY,
        theme: "grid",
        headStyles: { fillColor: [0, 91, 150] },
        styles: { fontSize: 11 },
        head: [["Parameter", "Value"]],
        body: [
          ["Room", roomName],
          ["Temperature", tValRaw + " °C"],
          ["Relative Humidity", rhValRaw + " %"],
          ["Target RH", targetValRaw + " %"],
        ]
      });

      cursorY = doc.lastAutoTable.finalY + 10;

      // 2. CALCULATED RESULTS TABLE
      doc.setFontSize(14);
      doc.text("2. Calculated Moisture Results", marginLeft, cursorY);
      cursorY += 4;

      doc.autoTable({
        startY: cursorY,
        theme: "grid",
        headStyles: { fillColor: [0, 91, 150] },
        styles: { fontSize: 11 },
        head: [["Result", "Value"]],
        body: [
          ["Dew Point", dewValRaw + " °C"],
          ["Required Temperature for Target RH", reqValRaw + " °C"],
          ["Estimated RH at 20°C", rh20ValRaw + " %"],
        ]
      });

      cursorY = doc.lastAutoTable.finalY + 10;

      // 3. VENTILATION TABLE
      if (lastVolume !== null) {
        const roomTypeText = document.getElementById("roomType")
          .selectedOptions[0].textContent;

        doc.setFontSize(14);
        doc.text("3. Ventilation Performance", marginLeft, cursorY);
        cursorY += 4;

        doc.autoTable({
          startY: cursorY,
          theme: "grid",
          headStyles: { fillColor: [0, 91, 150] },
          styles: { fontSize: 11 },
          columnStyles: {
            1: { cellWidth: 120 }
          },
          head: [["Metric", "Value"]],
          body: [
            ["Room Type", roomTypeText],
            ["Room Volume", lastVolume.toFixed(1) + " m³"],
            ["Ventilation Assessment", lastVentSummary]
          ]
        });

        cursorY = doc.lastAutoTable.finalY + 10;
      }

      // 4. Moisture behaviour graph
      doc.setFontSize(14);
      doc.text("4. Moisture behaviour example (illustrative)", marginLeft, cursorY);
      cursorY += 4;

      const graphBottomY = drawMoistureGraph(
        doc,
        cursorY,
        tVal,
        rhVal,
        reqVal,
        targetVal,
        rh20Val
      );

      cursorY = graphBottomY + 6;

      doc.setFontSize(10);
      const maxWidth = 180;
      const expl1 = doc.splitTextToSize(
        "The graph illustrates how, for a constant amount of moisture in the air, " +
        "increasing the air temperature lowers the relative humidity. The line between the current " +
        "condition and the required temperature point follows a constant moisture line on a psychrometric chart.",
        maxWidth
      );
      doc.text(expl1, marginLeft, cursorY);
      cursorY += expl1.length * 4 + 4;

      // 5. Technical basis & guidance
      if (cursorY > 260) {
        doc.addPage();
        cursorY = 18;
      }

      doc.setFontSize(14);
      doc.text("5. Technical basis and guidance", marginLeft, cursorY);
      cursorY += 6;

      doc.setFontSize(11);
      const technicalLines = [
        "• Dew point is calculated using standard saturation vapour pressure relationships (Magnus-type equation) from the measured temperature and relative humidity.",
        "• Required temperature for the target RH assumes moisture content stays broadly constant while the air is heated.",
        "• The estimated RH at 20°C shows what the relative humidity would be if the air were warmed to 20°C without adding or removing moisture.",
        "• Ventilation performance is expressed as air changes per hour (ACH), using the room volume and extract rate in litres/second.",
        "• Recommended ACH values vary by room type: lower in bedrooms/living rooms, higher in kitchens, bathrooms and drying spaces.",
        "• These calculations are intended as professional guidance to support on-site judgement, not as a replacement for a full building pathology assessment."
      ];

      technicalLines.forEach(line => {
        const wrapped = doc.splitTextToSize(line, maxWidth);
        if (cursorY > 270) {
          doc.addPage();
          cursorY = 18;
        }
        doc.text(wrapped, marginLeft, cursorY);
        cursorY += wrapped.length * 5 + 2;
      });

      // FOOTER
      doc.setFontSize(9);
      doc.setTextColor(100);
      doc.text(
        "Generated by CM Toolbox – Condensation & Ventilation Tool • © Your Name / Company",
        marginLeft,
        290
      );

      doc.save("condensation-ventilation-report.pdf");
    }

    /* ---------- AIR TEST / ENVELOPE CALCULATOR ---------- */
    function calcAirTest() {
      const L = toNum(document.getElementById("at_length").value);
      const W = toNum(document.getElementById("at_width").value);
      const storeys = toNum(document.getElementById("at_storeys").value);
      const H = toNum(document.getElementById("at_height").value);
      const flow = toNum(document.getElementById("at_flow").value);

      const volEl = document.getElementById("at_volume");
      const envEl = document.getElementById("at_envelope");
      const qEl = document.getElementById("at_q50");
      const nEl = document.getElementById("at_n50");
      const cEl = document.getElementById("at_comment");

      volEl.textContent = "–";
      envEl.textContent = "–";
      qEl.textContent = "–";
      nEl.textContent = "–";
      cEl.textContent = "";

      if (L === null || W === null || storeys === null || H === null ||
          L <= 0 || W <= 0 || storeys <= 0 || H <= 0) {
        cEl.textContent = "Enter length, width, storeys and storey height to estimate envelope and volume.";
        return;
      }

      const volume = L * W * H * storeys; // m³
      // Walls area = perimeter * height * storeys
      const walls = 2 * (L + W) * H * storeys;
      // Floor and roof area
      const floorRoof = 2 * (L * W);
      const envelope = walls + floorRoof;

      volEl.textContent = volume.toFixed(1);
      envEl.textContent = envelope.toFixed(1);

      if (flow === null || flow <= 0) {
        cEl.textContent =
          "Approximate box-model only. Add measured flow at 50 Pa to estimate q₅₀ and n₅₀.";
        return;
      }

      const q50 = flow / envelope;  // m³/(h·m²)
      const n50 = flow / volume;    // 1/h

      qEl.textContent = q50.toFixed(2);
      nEl.textContent = n50.toFixed(2);

      let comment = "";
      if (q50 <= 3) {
        comment = "Very good air-tightness for a typical dwelling. Check that background ventilation is adequate.";
      } else if (q50 <= 5) {
        comment = "Generally good air-tightness. Often close to modern design targets.";
      } else if (q50 <= 10) {
        comment = "Moderate air-tightness. May be typical of older or partially improved stock.";
      } else {
        comment = "Leaky envelope result. Consider if further fabric or detailing work is appropriate.";
      }
      comment += " Always use the official test certificate for compliance and SAP inputs.";

      cEl.textContent = comment;
    }

    /* ---------- MOISTURE DIAGNOSIS LOGIC ---------- */
    function calcMoistureDiagnosis() {
      const age = document.getElementById("md_age").value;
      const heating = document.getElementById("md_heating").value;
      const vent = document.getElementById("md_vent").value;

      const symptomEls = document.querySelectorAll(".md-symptom");
      const symptoms = [];
      symptomEls.forEach(el => {
        if (el.checked) symptoms.push(el.value);
      });

      const mainEl = document.getElementById("md_main");
      const secEl = document.getElementById("md_secondary");
      const actEl = document.getElementById("md_actions");

      if (symptoms.length === 0 && !age && !heating && !vent) {
        mainEl.textContent = "Select symptoms to see likely causes.";
        secEl.textContent = "";
        actEl.textContent = "";
        return;
      }

      let scores = {
        condensation: 0,
        thermal: 0,
        penetrating: 0,
        rising: 0,
        plumbing: 0
      };

      // Symptom scoring
      if (symptoms.includes("mouldCorners")) {
        scores.condensation += 3;
        scores.thermal += 2;
      }
      if (symptoms.includes("windowCond")) {
        scores.condensation += 3;
      }
      if (symptoms.includes("ceilingEdge")) {
        scores.thermal += 3;
        scores.condensation += 1;
      }
      if (symptoms.includes("patchMidWall")) {
        scores.penetrating += 3;
        scores.plumbing += 1;
      }
      if (symptoms.includes("tideMarks")) {
        scores.rising += 4;
      }
      if (symptoms.includes("chimney")) {
        scores.penetrating += 3;
      }
      if (symptoms.includes("roofGutter")) {
        scores.penetrating += 4;
      }
      if (symptoms.includes("exposedWall")) {
        scores.penetrating += 2;
        scores.thermal += 1;
      }
      if (symptoms.includes("pipeLocal")) {
        scores.plumbing += 4;
      }
      if (symptoms.includes("aboveCeiling")) {
        scores.plumbing += 3;
        scores.penetrating += 1;
      }
      if (symptoms.includes("manyOccupants")) {
        scores.condensation += 3;
      }
      if (symptoms.includes("coldHouse")) {
        scores.condensation += 2;
        scores.thermal += 2;
      }

      // Context scoring
      if (heating === "intermittent") {
        scores.condensation += 2;
        scores.thermal += 1;
      } else if (heating === "evening") {
        scores.condensation += 1;
      }

      if (vent === "poor") {
        scores.condensation += 3;
      } else if (vent === "mixed") {
        scores.condensation += 1;
      }

      if (age === "pre1919") {
        scores.rising += 1;
        scores.penetrating += 1;
      } else if (age === "newbuild") {
        scores.condensation += 1;
        scores.thermal += 1;
      }

      // Determine top causes
      let entries = Object.entries(scores);
      entries.sort((a, b) => b[1] - a[1]);
      const top = entries[0];
      const second = entries[1];

      const labelMap = {
        condensation: "Condensation-related moisture",
        thermal: "Thermal bridging / cold surface risk",
        penetrating: "Penetrating damp (rain / external defects)",
        rising: "Possible rising damp",
        plumbing: "Possible plumbing / service leak"
      };

      const explainMap = {
        condensation:
          "Patterns and context suggest that indoor moisture and surface temperatures are a significant factor. This often appears as mould on external walls, corners, behind furniture and around windows.",
        thermal:
          "There are signs of cold surface effects (thermal bridges), especially at junctions and exposed elements. These areas are more prone to condensation and mould even where the rest of the room is performing reasonably.",
        penetrating:
          "Symptoms are consistent with moisture tracking through the fabric from the outside, such as defective pointing, gutters, flashings, or exposed elevations.",
        rising:
          "Tide marks and low-level damp are consistent with moisture rising from the ground or bridging across a damp proof course. Further investigation would normally be recommended.",
        plumbing:
          "Localised staining near services suggests a plumbing or service-related leak. This can be intermittent and may require opening up or monitoring."
      };

      const actionsMap = {
        condensation:
          "Typical actions: review heating pattern, support occupants with achievable setpoints, improve ventilation (e.g. dMEV or trickle vents), move furniture away from cold walls, reduce moisture production (drying indoors, unvented tumble dryers, etc.).",
        thermal:
          "Typical actions: consider insulation or lining to cold elements, improve detailing at junctions, and in the interim maintain steadier temperatures and ventilation to limit surface RH at these locations.",
        penetrating:
          "Typical actions: inspect roof coverings, gutters, downpipes, flashings, pointing and external finishes. Address defects and check cavity trays, weep holes and sealant details around openings.",
        rising:
          "Typical actions: check damp proof course level, bridging by paths or raised ground, internal plaster and floor details. Consider specialist rising damp investigation if defects are not obvious.",
        plumbing:
          "Typical actions: trace pipe routes, inspect fittings and joints, consider moisture monitoring and, if necessary, controlled opening up to confirm and repair any leak."
      };

      let mainText = "";
      let secondaryText = "";
      let actionText = "";

      if (!top || top[1] === 0) {
        mainText = "Insufficient information to point strongly to one mechanism.";
        secondaryText = "Consider gathering more detail on heating pattern, ventilation use, external defects and the exact position/shape of staining.";
        actionText = "";
      } else {
        mainText = "Most likely mechanism: " + labelMap[top[0]];
        secondaryText = explainMap[top[0]] || "";

        if (second && second[1] > 0 && second[1] >= top[1] - 2) {
          secondaryText += " A secondary contributing factor may be: " + labelMap[second[0]] + ".";
        }

        actionText = actionsMap[top[0]] || "";
      }

      mainEl.textContent = mainText;
      secEl.textContent = secondaryText;
      actEl.textContent = actionText;
    }

    /* ---------- HEAT-LOSS & RADIATOR SIZING ---------- */
    function calcHeatLoss() {
      const L = toNum(document.getElementById("hl_length").value);
      const W = toNum(document.getElementById("hl_width").value);
      const H = toNum(document.getElementById("hl_height").value);
      const Tint = toNum(document.getElementById("hl_tint").value);
      const Text = toNum(document.getElementById("hl_text").value);

      const extWalls = parseInt(document.getElementById("hl_extWalls").value || "0", 10);
      const Uwall = toNum(document.getElementById("hl_uwall").value);
      const Awin = toNum(document.getElementById("hl_awin").value);
      const Uwin = toNum(document.getElementById("hl_uwin").value);
      const Ufloor = toNum(document.getElementById("hl_ufloor").value);
      const Uroof = toNum(document.getElementById("hl_uroof").value);

      const dTEl = document.getElementById("hl_dT");
      const QfEl = document.getElementById("hl_Qfabric");
      const QdEl = document.getElementById("hl_Qdesign");
      const RadEl = document.getElementById("hl_rad");

      dTEl.textContent = "–";
      QfEl.textContent = "–";
      QdEl.textContent = "–";
      RadEl.textContent = "–";

      if (L === null || W === null || H === null || Tint === null || Text === null ||
          Uwall === null || Uwin === null || Ufloor === null || Uroof === null ||
          L <= 0 || W <= 0 || H <= 0) {
        return;
      }

      const dT = Tint - Text; // K
      if (!isFinite(dT) || dT <= 0) {
        dTEl.textContent = "–";
        return;
      }

      const areaFloor = L * W;
      const areaRoof = areaFloor;

      const perimeter = 2 * (L + W);
      const extFraction = Math.min(Math.max(extWalls / 4, 0), 1);
      const areaWalls = perimeter * H * extFraction;

      const AwinUse = Math.max(Awin || 0, 0);
      const AwallNet = Math.max(areaWalls - AwinUse, 0);

      const H_wall = AwallNet * Uwall;
      const H_win = AwinUse * Uwin;
      const H_floor = areaFloor * Ufloor;
      const H_roof = areaRoof * Uroof;

      const H_fabric = H_wall + H_win + H_floor + H_roof;

      dTEl.textContent = dT.toFixed(1);
      QfEl.textContent = H_fabric.toFixed(1);

      if (!isFinite(H_fabric) || H_fabric <= 0) {
        return;
      }

      const Q_basic = H_fabric * dT;
      const Q_design = Q_basic * 1.1; // 10% margin
      QdEl.textContent = Q_design.toFixed(0);

      const radRounded = Math.round(Q_design / 50) * 50;
      RadEl.textContent = radRounded.toString();
    }

    /* ---------- EVENT LISTENERS ---------- */
    document.addEventListener("input", e => {
      // Condensation tool
      if (
        e.target.matches("select") ||
        e.target.matches("#roomWidth") ||
        e.target.matches("#roomLength") ||
        e.target.matches("#roomHeight") ||
        e.target.matches("#extractRate")
      ) {
        if (
          e.target.id === "roomWidth" ||
          e.target.id === "roomLength" ||
          e.target.id === "roomHeight" ||
          e.target.id === "extractRate" ||
          e.target.id === "roomType"
        ) {
          calcVent();
        } else if (e.target.id === "temp" || e.target.id === "rh" || e.target.id === "targetRh") {
          calc();
        }
      }

      // Air test
      if (
        e.target.matches("#at_length") ||
        e.target.matches("#at_width") ||
        e.target.matches("#at_storeys") ||
        e.target.matches("#at_height") ||
        e.target.matches("#at_flow")
      ) {
        calcAirTest();
      }

      // Moisture diagnosis
      if (
        e.target.classList.contains("md-symptom") ||
        e.target.id === "md_age" ||
        e.target.id === "md_heating" ||
        e.target.id === "md_vent"
      ) {
        calcMoistureDiagnosis();
      }

      // Heat loss
      if (
        e.target.id === "hl_length" ||
        e.target.id === "hl_width" ||
        e.target.id === "hl_height" ||
        e.target.id === "hl_tint" ||
        e.target.id === "hl_text" ||
        e.target.id === "hl_extWalls" ||
        e.target.id === "hl_uwall" ||
        e.target.id === "hl_awin" ||
        e.target.id === "hl_uwin" ||
        e.target.id === "hl_ufloor" ||
        e.target.id === "hl_uroof"
      ) {
        calcHeatLoss();
      }
    });

    document.addEventListener("change", e => {
      if (e.target.matches("select") && e.target.id !== "roomType") {
        if (e.target.id === "temp" || e.target.id === "rh" || e.target.id === "targetRh") {
          calc();
        }
      }

      if (
        e.target.id === "md_age" ||
        e.target.id === "md_heating" ||
        e.target.id === "md_vent"
      ) {
        calcMoistureDiagnosis();
      }

      if (
        e.target.id === "hl_extWalls" ||
        e.target.id === "hl_uwall" ||
        e.target.id === "hl_uwin" ||
        e.target.id === "hl_ufloor" ||
        e.target.id === "hl_uroof"
      ) {
        calcHeatLoss();
      }
    });

    // Initial run
    calc();
    loadSavedRooms();
  </script>
</body>
</html>