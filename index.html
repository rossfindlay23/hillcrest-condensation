<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Condensation & Ventilation Surveyor Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <style>
    :root {
      --primary: #005b96;
      --primary-light: #e5f1fb;
      --accent: #009fdf;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      background: #f5f5f5;
      color: #222;
      font-size: 15px;
    }

    .page {
      width: 100%;
      margin: 0;
      padding: 0 12px 18px;
      box-sizing: border-box;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      margin-bottom: 10px;
    }

    .app-icon {
      height: 34px;
      width: 34px;
      border-radius: 8px;
      border: 2px solid rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--accent));
    }

    .title-block {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      font-size: 17px;
      margin: 0;
      line-height: 1.2;
    }

    header span {
      font-size: 11px;
      opacity: 0.9;
    }

    h2 {
      margin: 6px 0 0 0;
      font-size: 19px;
      font-weight: 700;
      color: var(--primary);
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    .note {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }

    label {
      display: block;
      margin-top: 0.7em;
      font-size: 14px;
      color: #333;
    }

    select {
      width: 100%;
      padding: 10px 10px;
      margin-top: 0.35em;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 17px;
      -webkit-appearance: none;
      background-color: #fff;
    }

    input[type="number"] {
      width: 100%;
      padding: 8px 8px;
      margin-top: 0.35em;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 15px;
    }

    .card {
      margin-top: 10px;
      padding: 12px 10px;
      border-radius: 8px;
      border: 1px solid #d2e2f0;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .card-header {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--primary);
    }

    .result-line {
      margin: 3px 0;
      font-size: 14px;
    }

    .big {
      font-weight: 600;
      font-size: 15px;
      color: var(--primary);
    }

    #requiredTemp {
      background: var(--primary-light);
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
    }

    .warning {
      color: #b00020;
      margin-top: 5px;
      font-size: 13px;
    }

    .tenant-text {
      margin-top: 7px;
      padding-top: 5px;
      border-top: 1px dashed #d2e2f0;
      font-size: 12px;
      color: #444;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn {
      flex-grow: 1;
      text-align: center;
      padding: 7px 6px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #d2e2f0;
      color: var(--primary);
    }

    .info-inline {
      flex-grow: 0;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 4px;
      margin-left: 4px;
    }

    #staffInfo {
      margin-top: 8px;
      display: none;
    }

    .saved-rooms {
      margin-top: 10px;
      font-size: 13px;
    }

    .saved-rooms-list {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .saved-room-chip {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid #d2e2f0;
      background: #f0f7fb;
      font-size: 12px;
      cursor: pointer;
    }

    .saved-room-chip span {
      font-weight: 600;
    }

    .vent-section {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #d2e2f0;
      font-size: 13px;
    }

    .vent-inline {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .vent-inline > div {
      flex: 1;
      min-width: 40%;
    }

    .vent-result {
      font-size: 13px;
      margin-top: 4px;
    }

    .vent-ok {
      color: #1b7f2a;
      font-weight: 600;
    }

    .vent-low {
      color: #b00020;
      font-weight: 600;
    }

    #reportText {
      font-size: 12px;
      white-space: pre-wrap;
      background: #f7f9fb;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e0e7ec;
      max-height: 140px;
      overflow-y: auto;
      margin-top: 4px;
    }

    footer {
      text-align: center;
      font-size: 10px;
      color: #777;
      padding: 4px 0 2px;
    }
  </style>
</head>

<body>
  <header>
    <div class="app-icon">Cv</div>
    <div class="title-block">
      <h1>Condensation & Ventilation Tool</h1>
      <span>For surveyors, housing & retrofit assessments</span>
    </div>
  </header>

  <div class="page">
    <div class="top-row">
      <h2>Room moisture check</h2>
      <button class="btn btn-outline info-inline" type="button" onclick="toggleStaffInfo()">
        ℹ️ Help
      </button>
    </div>

    <p class="note">
      Estimate dew point, required heating temperature and ventilation performance to support
      damp and mould investigations on site.
    </p>

    <div id="staffInfo" class="card">
      <div class="card-header">How to use on site</div>
      <div class="result-line">1. Take a room temperature and RH reading using a hygrometer.</div>
      <div class="result-line">2. Select the nearest values below. Keep target RH at 60% unless you have a specific reason to use another value.</div>
      <div class="result-line">3. Use the highlighted “Required temperature” as part of your heating advice.</div>
      <div class="result-line">4. Use the ventilation section to check whether the extract looks broadly adequate for the room size and type.</div>
      <div class="result-line">5. Use the generated report text/PDF in your notes, letters or case management system.</div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" type="button" onclick="resetForm()">Reset / clear</button>
      <button class="btn btn-outline" type="button" onclick="saveRoom()">Save this room</button>
    </div>

    <label>
      Current temperature (°C)
      <select id="temp">
        <option value="">Select temperature…</option>
        <option value="10">10.0</option><option value="10.5">10.5</option>
        <option value="11">11.0</option><option value="11.5">11.5</option>
        <option value="12">12.0</option><option value="12.5">12.5</option>
        <option value="13">13.0</option><option value="13.5">13.5</option>
        <option value="14">14.0</option><option value="14.5">14.5</option>
        <option value="15">15.0</option><option value="15.5">15.5</option>
        <option value="16">16.0</option><option value="16.5">16.5</option>
        <option value="17">17.0</option><option value="17.5">17.5</option>
        <option value="18">18.0</option><option value="18.5">18.5</option>
        <option value="19">19.0</option><option value="19.5">19.5</option>
        <option value="20">20.0</option><option value="20.5">20.5</option>
        <option value="21">21.0</option><option value="21.5">21.5</option>
        <option value="22">22.0</option><option value="22.5">22.5</option>
        <option value="23">23.0</option><option value="23.5">23.5</option>
        <option value="24">24.0</option><option value="24.5">24.5</option>
        <option value="25">25.0</option>
      </select>
    </label>

    <label>
      Current relative humidity (%)
      <select id="rh">
        <option value="">Select RH…</option>
        <option value="40">40%</option><option value="45">45%</option>
        <option value="50">50%</option><option value="55">55%</option>
        <option value="60">60%</option><option value="65">65%</option>
        <option value="70">70%</option><option value="75">75%</option>
        <option value="80">80%</option><option value="85">85%</option>
        <option value="90">90%</option>
      </select>
    </label>

    <label>
      Target relative humidity (%)
      <span class="note">(Typical target 60% RH.)</span>
      <select id="targetRh">
        <option value="55">55%</option>
        <option value="60" selected>60%</option>
        <option value="65">65%</option>
        <option value="70">70%</option>
      </select>
    </label>

    <div id="warning" class="warning"></div>

    <div class="card">
      <div class="card-header">Calculated results</div>

      <div class="result-line big">
        Dew point: <span id="dewpoint">–</span> °C
      </div>

      <div class="result-line big">
        Required temp to reach target RH: <span id="requiredTemp">–</span> °C
      </div>

      <div class="result-line">
        Estimated RH if heated to 20°C: <span id="rhAt20">–</span>%
      </div>

      <div class="tenant-text" id="tenantText">
        Once you select the values above, a simple explanation for occupants will appear here.
      </div>

      <div class="vent-section">
        <div class="card-header" style="margin-bottom:4px;">Ventilation check (optional)</div>
        <label style="margin-top:0;">
          Room type (sets target ACH)
          <select id="roomType">
            <option value="bed" selected>Bedroom / Living room (target ~3 ACH)</option>
            <option value="kit">Kitchen (target ~5 ACH)</option>
            <option value="bath">Bathroom / shower room (target ~7 ACH)</option>
            <option value="util">Utility / drying room (target ~6 ACH)</option>
          </select>
        </label>
        <p class="note" style="margin-top:2px;">
          Enter room dimensions and extract rate. Volume is calculated automatically and used to estimate ACH.
        </p>
        <div class="vent-inline">
          <div>
            <label style="margin-top:0;">
              Width (m)
              <input type="number" id="roomWidth" step="0.1" placeholder="e.g. 4">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Length (m)
              <input type="number" id="roomLength" step="0.1" placeholder="e.g. 3.5">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Height (m)
              <input type="number" id="roomHeight" step="0.1" placeholder="e.g. 2.4">
            </label>
          </div>
          <div>
            <label style="margin-top:0;">
              Extract rate (L/s)
              <input type="number" id="extractRate" step="0.1" placeholder="e.g. 15">
            </label>
          </div>
        </div>
        <div class="vent-result" id="ventResult">
          Enter width, length, height and extract rate to estimate volume and air changes per hour (ACH).
        </div>
      </div>
    </div>

    <div class="saved-rooms">
      <div class="card-header">Saved rooms on this device</div>
      <div class="note">Tap a room to load its values back into the calculator.</div>
      <div class="saved-rooms-list" id="savedRoomsList"></div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div class="card-header">Generated report text</div>
      <p class="note">Use this text or download as PDF for your records.</p>
      <div id="reportText">No report generated yet.</div>
      <div class="btn-row" style="margin-top:6px;">
        <button class="btn btn-outline" type="button" onclick="generateReport()">Generate report</button>
        <button class="btn btn-primary" type="button" onclick="downloadPdf()">Download PDF report</button>
      </div>
    </div>

    <p class="note" style="margin-top:6px;">
      For professional guidance only. Assumes moisture levels remain constant during heating.
      Based on standard psychrometric relationships.
    </p>
  </div>

  <footer>
    Condensation & Ventilation Tool • © Your Name / Company
  </footer>

  <!-- jsPDF and AutoTable for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    const STORAGE_KEY = "cvtool_saved_rooms_v1";
    let currentRoomName = "Current room";
    let lastVentSummary = "";
    let lastVolume = null;

    function satVapPressure(T) {
      return 0.6108 * Math.exp((17.27 * T) / (T + 237.3));
    }

    function tempFromSatVapPressure(es) {
      const lnTerm = Math.log(es / 0.6108);
      return (237.3 * lnTerm) / (17.27 - lnTerm);
    }

    function toNum(v) {
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }

    function getTargetAch() {
      const type = document.getElementById("roomType").value;
      switch (type) {
        case "kit": return 5.0;
        case "bath": return 7.0;
        case "util": return 6.0;
        case "bed":
        default: return 3.0;
      }
    }

    function calc() {
      const t = toNum(document.getElementById("temp").value);
      const rh = toNum(document.getElementById("rh").value);
      const targetRh = toNum(document.getElementById("targetRh").value);

      const warningEl = document.getElementById("warning");
      const dewEl = document.getElementById("dewpoint");
      const reqEl = document.getElementById("requiredTemp");
      const rh20El = document.getElementById("rhAt20");
      const tenantEl = document.getElementById("tenantText");

      warningEl.textContent = "";
      dewEl.textContent = "–";
      reqEl.textContent = "–";
      rh20El.textContent = "–";
      tenantEl.textContent =
        "Once you select the values above, a simple explanation for occupants will appear here.";

      if (t === null || rh === null || targetRh === null) {
        calcVent();
        return;
      }

      const es = satVapPressure(t);
      const e = (rh / 100) * es;

      const dewpoint = tempFromSatVapPressure(e);
      const esReq = e * (100 / targetRh);
      const requiredTemp = tempFromSatVapPressure(esReq);
      const es20 = satVapPressure(20);
      const rhAt20 = (e / es20) * 100;

      if (isFinite(dewpoint)) dewEl.textContent = dewpoint.toFixed(1);
      if (isFinite(requiredTemp)) reqEl.textContent = requiredTemp.toFixed(1);
      if (isFinite(rhAt20)) rh20El.textContent = rhAt20.toFixed(0);

      if (isFinite(requiredTemp) && isFinite(rhAt20)) {
        tenantEl.innerHTML =
          "Based on the current temperature of <strong>" + t.toFixed(1) + "°C</strong> at about " +
          rh.toFixed(0) + "% humidity, heating the room to around <strong>" +
          requiredTemp.toFixed(1) + "°C</strong> would bring the humidity down towards " +
          targetRh.toFixed(0) + "%." +
          " If the home is heated to <strong>20°C</strong>, the humidity would be roughly " +
          rhAt20.toFixed(0) + "%." +
          " Ventilation measures and reducing moisture (for example, lids on pans, drying clothes in a ventilated room, using/installing dMEV extract fans) is important and will help maintain a healthy environment within the home.";
      }

      calcVent();
    }

    function calcVent() {
      const w = toNum(document.getElementById("roomWidth").value);
      const l = toNum(document.getElementById("roomLength").value);
      const h = toNum(document.getElementById("roomHeight").value);
      const rate = toNum(document.getElementById("extractRate").value);
      const ventEl = document.getElementById("ventResult");

      lastVentSummary = "";
      lastVolume = null;

      if (w === null || l === null || h === null || rate === null ||
          w <= 0 || l <= 0 || h <= 0 || rate <= 0) {
        ventEl.textContent =
          "Enter width, length, height and extract rate to estimate volume and air changes per hour (ACH).";
        return;
      }

      const volume = w * l * h; // m³
      lastVolume = volume;

      const m3h = rate * 3.6; // L/s -> m³/h
      const ach = m3h / volume;
      const targetAch = getTargetAch();

      let label =
        "Approx. room volume: " + volume.toFixed(1) + " m³. " +
        "Estimated ACH: " + ach.toFixed(1) + " air changes/hour. ";

      if (ach >= targetAch) {
        label += "This is broadly in a reasonable range for this type of room.";
        ventEl.innerHTML = '<span class="vent-ok">' + label + "</span>";
      } else {
        const requiredLs = (targetAch * volume) / 3.6; // L/s needed for target ACH
        label +=
          "This appears low – consider improving extract capacity or run-time. " +
          "To achieve around " + targetAch.toFixed(1) +
          " air changes/hour for this room type, the extract would need to be approximately " +
          requiredLs.toFixed(1) + " L/s based on the dimensions entered.";
        ventEl.innerHTML = '<span class="vent-low">' + label + "</span>";
      }

      lastVentSummary = label;
    }

    function resetForm() {
      document.getElementById("temp").value = "";
      document.getElementById("rh").value = "";
      document.getElementById("targetRh").value = "60";

      document.getElementById("roomType").value = "bed";
      document.getElementById("roomWidth").value = "";
      document.getElementById("roomLength").value = "";
      document.getElementById("roomHeight").value = "";
      document.getElementById("extractRate").value = "";

      document.getElementById("reportText").textContent = "No report generated yet.";
      lastVentSummary = "";
      lastVolume = null;
      calc();
    }

    function toggleStaffInfo() {
      const el = document.getElementById("staffInfo");
      el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
    }

    function loadSavedRooms() {
      const listEl = document.getElementById("savedRoomsList");
      listEl.innerHTML = "";
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      let rooms;
      try {
        rooms = JSON.parse(raw);
      } catch {
        return;
      }
      if (!Array.isArray(rooms) || rooms.length === 0) return;

      rooms.forEach((room, idx) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "saved-room-chip";
        chip.innerHTML = "<span>" + room.name + "</span>";
        chip.onclick = () => loadRoom(idx);
        listEl.appendChild(chip);
      });
    }

    function saveRoom() {
      const tVal = document.getElementById("temp").value;
      const rhVal = document.getElementById("rh").value;
      const targetVal = document.getElementById("targetRh").value;
      const dewVal = document.getElementById("dewpoint").textContent;
      const reqVal = document.getElementById("requiredTemp").textContent;
      const rh20Val = document.getElementById("rhAt20").textContent;

      if (!tVal || !rhVal || !targetVal || dewVal === "–" || reqVal === "–") {
        alert("Please select values and run the calculation before saving a room.");
        return;
      }

      const name = prompt("Room name (e.g. Bedroom 1, Lounge):");
      if (!name) return;

      const raw = localStorage.getItem(STORAGE_KEY);
      let rooms = [];
      if (raw) {
        try {
          rooms = JSON.parse(raw) || [];
        } catch {
          rooms = [];
        }
      }

      rooms.push({
        name,
        temp: tVal,
        rh: rhVal,
        targetRh: targetVal,
        dew: dewVal,
        requiredTemp: reqVal,
        rhAt20: rh20Val
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
      currentRoomName = name;
      loadSavedRooms();
    }

    function loadRoom(index) {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      let rooms;
      try {
        rooms = JSON.parse(raw);
      } catch {
        return;
      }
      const room = rooms[index];
      if (!room) return;

      document.getElementById("temp").value = room.temp;
      document.getElementById("rh").value = room.rh;
      document.getElementById("targetRh").value = room.targetRh;
      currentRoomName = room.name;
      calc();
    }

    function generateReport() {
      const tVal = document.getElementById("temp").value;
      const rhVal = document.getElementById("rh").value;
      const targetVal = document.getElementById("targetRh").value;
      const dewVal = document.getElementById("dewpoint").textContent;
      const reqVal = document.getElementById("requiredTemp").textContent;
      const rh20Val = document.getElementById("rhAt20").textContent;
      const reportEl = document.getElementById("reportText");

      if (!tVal || !rhVal || !targetVal || dewVal === "–" || reqVal === "–" || rh20Val === "–") {
        alert("Please select values and run the calculation before generating a report.");
        return;
      }

      const lines = [];
      lines.push("Room: " + (currentRoomName || "Current room"));
      lines.push("Temperature: " + parseFloat(tVal).toFixed(1) + " °C");
      lines.push("Relative humidity: " + parseFloat(rhVal).toFixed(0) + " %");
      lines.push("Target relative humidity: " + parseFloat(targetVal).toFixed(0) + " %");
      lines.push("Dew point: " + dewVal + " °C");
      lines.push("Required temperature to reach target RH: " + reqVal + " °C");
      lines.push("Estimated RH if heated to 20 °C: " + rh20Val + " %");

      if (lastVolume !== null) {
        lines.push("Approx. room volume: " + lastVolume.toFixed(1) + " m³");
      }

      if (lastVentSummary) {
        lines.push("");
        lines.push("Ventilation:");
        lines.push(lastVentSummary);
      }

      lines.push("");
      lines.push(
        "Advisory summary: Based on the current conditions, heating the room to around " +
        reqVal + " °C would help bring humidity down towards " + parseFloat(targetVal).toFixed(0) +
        "%. Ventilation measures and reducing moisture (for example, lids on pans, drying clothes in a ventilated room, using/installing dMEV extract fans) is important and will help maintain a healthy environment within the home."
      );

      reportEl.textContent = lines.join("\n");
    }

    async function downloadPdf() {
      const text = document.getElementById("reportText").textContent || "";
      if (!text || text === "No report generated yet.") {
        alert("Please generate a report first.");
        return;
      }

      if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API.autoTable) {
        alert("PDF library not loaded. Please check your connection and try again.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      const marginLeft = 12;
      let cursorY = 18;

      // HEADER BRANDING
      doc.setFillColor(0, 91, 150);
      doc.rect(0, 0, 210, 18, "F");
      doc.setTextColor(255, 255, 255);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("Condensation & Ventilation Survey Report", marginLeft, 12);
      doc.setTextColor(0, 0, 0);
      cursorY = 28;

      // TABLE 1 – INPUT CONDITIONS
      const roomName = currentRoomName || "Current room";
      const tVal = document.getElementById("temp").value || "-";
      const rhVal = document.getElementById("rh").value || "-";
      const targetVal = document.getElementById("targetRh").value || "-";

      doc.setFontSize(14);
      doc.text("1. Measured Conditions", marginLeft, cursorY);
      cursorY += 4;

      doc.autoTable({
        startY: cursorY,
        theme: "grid",
        headStyles: { fillColor: [0, 91, 150] },
        styles: { fontSize: 11 },
        head: [["Parameter", "Value"]],
        body: [
          ["Room", roomName],
          ["Temperature", tVal + " °C"],
          ["Relative Humidity", rhVal + " %"],
          ["Target RH", targetVal + " %"],
        ]
      });

      cursorY = doc.lastAutoTable.finalY + 10;

      // TABLE 2 – CALCULATED RESULTS
      const dewVal = document.getElementById("dewpoint").textContent || "-";
      const reqVal = document.getElementById("requiredTemp").textContent || "-";
      const rh20Val = document.getElementById("rhAt20").textContent || "-";

      doc.setFontSize(14);
      doc.text("2. Calculated Moisture Results", marginLeft, cursorY);
      cursorY += 4;

      doc.autoTable({
        startY: cursorY,
        theme: "grid",
        headStyles: { fillColor: [0, 91, 150] },
        styles: { fontSize: 11 },
        head: [["Result", "Value"]],
        body: [
          ["Dew Point", dewVal + " °C"],
          ["Required Temperature for Target RH", reqVal + " °C"],
          ["Estimated RH at 20°C", rh20Val + " %"],
        ]
      });

      cursorY = doc.lastAutoTable.finalY + 10;

      // TABLE 3 – VENTILATION RESULTS
      if (lastVolume !== null) {
        const roomTypeText = document.getElementById("roomType")
          .selectedOptions[0].textContent;

        doc.setFontSize(14);
        doc.text("3. Ventilation Performance", marginLeft, cursorY);
        cursorY += 4;

        doc.autoTable({
          startY: cursorY,
          theme: "grid",
          headStyles: { fillColor: [0, 91, 150] },
          styles: { fontSize: 11 },
          columnStyles: {
            1: { cellWidth: 120 }
          },
          head: [["Metric", "Value"]],
          body: [
            ["Room Type", roomTypeText],
            ["Room Volume", lastVolume.toFixed(1) + " m³"],
            ["Ventilation Assessment", lastVentSummary]
          ]
        });

        cursorY = doc.lastAutoTable.finalY + 12;
      }

      // SECTION 4 – PROFESSIONAL GUIDANCE
      doc.setFontSize(14);
      doc.text("4. Professional Guidance Summary", marginLeft, cursorY);
      cursorY += 6;

      const guidelines = [
        "• Heating the room to " +
          reqVal + "°C will help bring humidity toward the target level.",
        "• Maintaining adequate ventilation is essential to avoiding recurring moisture issues.",
        "• Reduce moisture sources where possible:",
        "  – Use pan lids when cooking",
        "  – Ensure extract fans operate effectively",
        "  – Dry clothes outdoors or in a ventilated space",
        "  – Avoid drying clothes on radiators",
        "• Monitoring temperatures and RH helps maintain a healthy indoor environment."
      ];

      doc.setFontSize(11);
      const maxWidth = 180;

      guidelines.forEach(line => {
        const split = doc.splitTextToSize(line, maxWidth);
        if (cursorY > 280) {
          doc.addPage();
          cursorY = 18;
        }
        doc.text(split, marginLeft, cursorY);
        cursorY += split.length * 5 + 2;
      });

      // FOOTER
      doc.setFontSize(9);
      doc.setTextColor(100);
      doc.text("Generated by Condensation & Ventilation Tool • © Your Name / Company", marginLeft, 290);

      doc.save("condensation-ventilation-report.pdf");
    }

    document.addEventListener("input", e => {
      if (
        e.target.matches("select") ||
        e.target.matches("#roomWidth") ||
        e.target.matches("#roomLength") ||
        e.target.matches("#roomHeight") ||
        e.target.matches("#extractRate")
      ) {
        if (
          e.target.id === "roomWidth" ||
          e.target.id === "roomLength" ||
          e.target.id === "roomHeight" ||
          e.target.id === "extractRate" ||
          e.target.id === "roomType"
        ) {
          calcVent();
        } else {
          calc();
        }
      }
    });

    document.addEventListener("change", e => {
      if (e.target.matches("select") && e.target.id !== "roomType") calc();
    });

    calc();
    loadSavedRooms();
  </script>
</body>
</html>